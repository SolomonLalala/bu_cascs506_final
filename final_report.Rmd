---
title: "Building an epigenetic clock based on methods and data from Hannum et al"
output: html_document
date: "`r Sys.Date()`"
Author: "Solomon Lalala"
---

# Setup

1.  Install R (4.4.3) and Rstudio.
2.  Clone the repository.
3.  Open final_report.Rmd in Rstudio.
4.  Install the following packages "tidyverse", "knitr", "caret", "glmnet", "ggplot2", "GEOquery", "foreach", "doParallel".

```{r Install packages, eval = FALSE}
install.packages(c("tidyverse", "knitr", "caret", "glmnet", "ggplot2", "GEOquery", "foreach", "doParallel"))
```

5.  Run the following codes

## Import scripts
```{r setup, eval = FALSE}
source("scripts/helper.R")
```

```{r set directory and dataset id}
data_dir <- "data" 
fig_dir <- "figures" 
gse_accession <- "GSE40279" 
```

# Collect data

```{r parse data, eval = FALSE}
# get data from geo
data_list <- parse_geo(dest_dir = data_dir, gse_id = gse_accession, transpose = TRUE, save = TRUE)
```

# Process data

## Extract metadata and merge with methylation data

```{r merge data}
merged <- extract_merge(gse_id = gse_accession, dest_dir = data_dir, save = TRUE)
```

## Viewing the data ()

```{r view data}
dim(merged)
# select 6 samples and 10 columns
view_merged(file.path(data_dir, paste0(gse_accession, "merged.rds")))
```

### view age distribution

```{r age distribution}
p_age_merged <- plot_age_distribution(
  data = merged,
  dest_dir = fig_dir, 
  save = TRUE)
p_age_merged
```

### view sex distribution

```{r sex distribution}
table(merged$sex)
```

## Split data into train and test sets

```{r split train and test}
train_test_list <- split_train_test(
  dataset = merged, 
  train_frac = 0.75, 
  stratifier = "age", 
  dest_dir = data_dir, 
  save = TRUE)
train_set <- train_test_list[[1]]
test_set <- train_test_list[[2]]
```

### check subset data distribution

```{r subset distribution}
# Check age distribution
p_age_train <- plot_age_distribution(data = train_set, dest_dir = fig_dir, save = TRUE)
p_age_train
p_age_test <- plot_age_distribution(data = test_set, dest_dir = fig_dir, save = TRUE)
p_age_test
table(train_set$sex)
table(test_set$sex)
```

## split data into predictor and target

```{r split predictor and target}
X_train <- train_set %>%
  select(-sample_id, -age, -ethnicity, -sex) # predictor
y_train <- train_set$age # prediction target

X_test <- test_set %>%
  select(-sample_id, -age, -ethnicity, -sex)
y_test <- test_set$age
```

```{r save splited data}
saveRDS(X_train, file = file.path(data_dir, "X_train.rds"))
saveRDS(y_train, file = file.path(data_dir, "y_train.rds"))
saveRDS(X_test, file = file.path(data_dir, "X_test.rds"))
saveRDS(y_test, file = file.path(data_dir, "y_test.rds"))
```

## standardize data

```{r center and scale data, eval = FALSE}
# obtain mean and sd
preProcValues <- preProcess(as.matrix(X_train), method = c("center", "scale"))

# Apply the transformation to the data
X_train_standardized <- predict(preProcValues, as.matrix(X_train))
X_test_standardized <- predict(preProcValues, as.matrix(X_test))
```

```{r save standardized data, eval = FALSE}
# save prepro_values and standardized data
saveRDS(preProcValues, file = file.path(data_dir, "preProcValues.rds"))
saveRDS(X_train_standardized, file = file.path(data_dir, "X_train_standardized.rds"))
saveRDS(X_test_standardized, file = file.path(data_dir, "X_test_standardized.rds"))
```

# Train model

## Set parameters

```{r set parameters}
alpha = 0.5
n_cores <- parallel::detectCores() - 1
n_fold = 10
iterations = 500
model_params <- list(
  n_cores = n_cores,
  alpha = alpha,
  n_fold = n_fold,
  iterations = iterations
)
```

```{r save parameters, eval = FALSE, echo = FALSE}
saveRDS(model_params, file = file.path(data_dir, "model_params.rds"))
```

## Find optimal parameters

### Cross-validation

```{r cv in r, eval = FALSE}
# Run locally
Rscript -e "source('scripts/cv.R')"
```

```{bash cv job, eval = FALSE}
# OR submit a job to SCC. You need to have access to SCC and set up the bash script
qsub scripts/cv.sh
```

### Find lambda

```{r find lambda}
cv_model <- readRDS(file.path(data_dir, "cv_model.rds"))
plot(cv_model)
```

```{r lambda min}
lambda_min <- cv_model$lambda.min
lambda_min
```

```{r save cv model, eval = FALSE}
ggsave(
  filename = file.path(fig_dir, "cv_model_lambda.png"),
  plot = plot(cv_model),
)
saveRDS(lambda_min, file = file.path(data_dir, "lambda_min.rds"))
```

## Select feature

### Bootstrap

```{bash Bootstrap job, eval = FALSE}
# Submit a job to SCC. You need to have access to SCC and set up the bash script
qsub scripts/bootstrap.sh
```

```{r Bootstrap in r, eval = FALSE}
# OR run locally. would be slow or could crash
Rscript -e "source('scripts/bootstrap.R')"
```

### Select feature

```{r Select feature}
bootstrap_res <- readRDS(file.path(data_dir, "bootstrap_results.rds"))
selected_feature <- select_feature(
  bootstrap_results = bootstrap_res, 
  threshold = 0.5,
  dest_dir = data_dir,
  save = TRUE)
```

#### view selected feature

```{r view selected feature}
selected_feature
```

## Train final model

```{r import data, echo = FALSE}
X_train_standardized <- readRDS(file.path(data_dir, "X_train_standardized.rds"))
y_train <- readRDS(file.path(data_dir, "y_train.rds"))
X_test_standardized <- readRDS(file.path(data_dir, "X_test_standardized.rds"))
y_test <- readRDS(file.path(data_dir, "y_test.rds"))
```

```{r train final model}
set.seed(123)
final_model <- glmnet(
    X_train_standardized, 
    y_train, 
    alpha = alpha, 
    lambda = lambda_min, 
    type.measure = "mse",
    family = "gaussian",
    standardize = FALSE)
```

```{r save final model, eval = FALSE}
saveRDS(final_model, file = file.path(data_dir, "final_model.rds"))
```

# Evaluate model

```{r evaluate model}
evaluation <- evaluate_model(
  model = final_model, 
  X_test = X_test_standardized, 
  y_test = y_test, 
  dest_dir = data_dir)
```

```{r view evaluation}
eval_res <- evaluation$results_df
eval_metrics <- evaluation$metrics
```

## Visualize evaluation results

```{r}
plot_eval <- plot_evaluation(
  results = eval_res, 
  metrics = eval_metrics, 
  dest_dir = fig_dir)
plot_eval
```

# Reference

```{r session-info}
sessionInfo()
```
